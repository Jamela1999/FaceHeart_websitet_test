<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexsas Sitemap Content Manager</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="assets/firebase-config.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .accordion-content {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .accordion-content.open {
            max-height: 9000px;
            opacity: 1;
        }

        .accordion-icon {
            transition: transform 0.2s;
        }

        .accordion-icon.open {
            transform: rotate(180deg);
        }

        .editor-row {
            transition: all 0.2s;
            border-bottom: 1px solid #f1f5f9;
        }

        .editor-row:last-child {
            border-bottom: none;
        }

        .editor-row:hover {
            background-color: #f8fafc;
        }

        .success-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 50;
        }

        .success-toast.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>

<body class="text-slate-800 antialiased min-h-screen">

    <div class="max-w-5xl mx-auto px-4 py-12">
        <div
            class="flex items-center justify-between mb-8 pb-4 border-b border-slate-200 sticky top-0 bg-[#f8fafc] z-40 py-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Sitemap Content Manager</h1>
                <p class="text-slate-500 mt-1">Manage text content logically grouped by page and section.</p>
            </div>
            <div class="flex gap-4">
                <a href="index.html" target="_blank"
                    class="px-5 py-2.5 bg-white border border-slate-300 text-slate-700 font-medium rounded-lg hover:bg-slate-50 transition-colors shadow-sm text-sm flex items-center gap-2">
                    <i data-lucide="external-link" class="w-4 h-4"></i> Preview Home
                </a>
                <button id="save-btn"
                    class="px-5 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm text-sm flex items-center gap-2">
                    <i data-lucide="cloud-upload" class="w-4 h-4"></i> Sync All Changes
                </button>
            </div>
        </div>

        <div id="loading" class="text-center py-20 text-slate-500">
            <svg class="animate-spin h-8 w-8 mx-auto mb-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            Loading categorized content maps...
        </div>

        <div id="content-container" class="hidden space-y-4">
            <!-- Accordions injected here -->
        </div>
    </div>

    <div id="toast" class="success-toast flex items-center gap-2">
        <i data-lucide="check-circle" class="w-5 h-5"></i>
        Changes synchronized to Firebase successfully!
    </div>

    <script>
        // Initialize lucide icons
        lucide.createIcons();

        document.addEventListener("DOMContentLoaded", async () => {
            const container = document.getElementById('content-container');
            const saveBtn = document.getElementById('save-btn');
            const loading = document.getElementById('loading');
            const toast = document.getElementById('toast');

            let structuredContent = {};
            let firebaseData = {};

            if (typeof database === 'undefined') {
                container.innerHTML = `<div class="p-8 bg-white rounded-xl text-center text-red-500 font-medium shadow-sm border border-red-200">Error: Firebase is not configured in assets/firebase-config.js.</div>`;
                loading.classList.add('hidden');
                container.classList.remove('hidden');
                return;
            }

            const sitemapRef = database.ref('sitemap/content');

            try {
                // Fetch the new structured JSON from Python
                const response = await fetch('content.json');
                structuredContent = await response.json();

                // Fetch overrides from Firebase
                sitemapRef.once('value', (snapshot) => {
                    firebaseData = snapshot.val() || {};
                    renderAccordions();
                });

            } catch (err) {
                console.error("Failed to load content:", err);
                loading.innerHTML = `<div class="text-red-500">Failed to load content.json. Did you run the Python extraction script?</div>`;
            }

            function renderAccordions() {
                container.innerHTML = '';

                // Iterate through Pages
                Object.keys(structuredContent).sort().forEach((pageName, pIndex) => {
                    const pageSections = structuredContent[pageName];
                    const pageBlock = document.createElement('div');
                    pageBlock.className = 'bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden';

                    // Count items in page
                    let pageTotalItems = 0;
                    Object.values(pageSections).forEach(sec => pageTotalItems += Object.keys(sec).length);

                    const pageHeaderId = `page-header-${pIndex}`;
                    const targetPageId = `page-content-${pIndex}`;

                    pageBlock.innerHTML = `
                        <button id="${pageHeaderId}" class="w-full flex items-center justify-between p-5 bg-white hover:bg-slate-50 transition-colors text-left focus:outline-none focus:bg-slate-50">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
                                    <i data-lucide="file-text" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h2 class="text-lg font-bold text-slate-800">${pageName}</h2>
                                    <p class="text-xs text-slate-500">${Object.keys(pageSections).length} sections, ${pageTotalItems} text elements</p>
                                </div>
                            </div>
                            <i data-lucide="chevron-down" class="w-5 h-5 text-slate-400 accordion-icon"></i>
                        </button>
                        <div id="${targetPageId}" class="accordion-content bg-slate-50 border-t border-slate-100">
                            <div class="p-4 space-y-4" id="sections-${pIndex}"></div>
                        </div>
                    `;
                    container.appendChild(pageBlock);

                    // Setup Page level toggle
                    document.getElementById(pageHeaderId).addEventListener('click', function () {
                        const content = document.getElementById(targetPageId);
                        const icon = this.querySelector('.accordion-icon');
                        content.classList.toggle('open');
                        icon.classList.toggle('open');
                    });

                    // Render Sections inside Page
                    const sectionsWrapper = document.getElementById(`sections-${pIndex}`);
                    Object.keys(pageSections).sort().forEach((sectionName, sIndex) => {
                        const sectionItems = pageSections[sectionName];
                        const sectionBlock = document.createElement('div');
                        sectionBlock.className = 'bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden';

                        const sectionTargetId = `section-${pIndex}-${sIndex}`;

                        let rowsHtml = '';
                        Object.keys(sectionItems).forEach(id => {
                            const item = sectionItems[id];
                            const currentValue = firebaseData[id] || '';
                            const hasOverride = currentValue.trim() !== '';

                            rowsHtml += `
                                <div class="grid grid-cols-12 gap-6 p-5 editor-row items-start ${hasOverride ? 'bg-blue-50/30' : ''}">
                                    <div class="col-span-3 pt-1 space-y-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-slate-100 text-slate-600 uppercase tracking-wider">
                                            &lt;${item.tag}&gt;
                                        </span>
                                        <div class="text-[11px] text-slate-400 font-mono bg-slate-100/50 px-2 py-1 rounded inline-block border border-slate-100">${id}</div>
                                    </div>
                                    <div class="col-span-4 pt-1 pr-4 text-sm text-slate-600 border-r border-slate-100 leading-relaxed font-medium">
                                        ${escapeHTML(item.text)}
                                    </div>
                                    <div class="col-span-5 relative">
                                        <textarea 
                                            class="w-full text-sm border-slate-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 p-3 min-h-[80px] resize-y bg-white" 
                                            placeholder="Leave empty to use original text..." 
                                            data-id="${id}"
                                        >${escapeHTML(currentValue)}</textarea>
                                        ${hasOverride ? `<span class="absolute top-3 right-3 flex h-2 w-2 rounded-full bg-blue-500"></span>` : ''}
                                    </div>
                                </div>
                            `;
                        });

                        sectionBlock.innerHTML = `
                            <button class="section-toggle w-full flex items-center justify-between p-4 bg-white hover:bg-slate-50 transition-colors border-b border-slate-100 text-left focus:outline-none">
                                <h3 class="font-semibold text-slate-700 flex items-center gap-2">
                                    <i data-lucide="layout" class="w-4 h-4 text-slate-400"></i>
                                    ${sectionName}
                                </h3>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs font-medium bg-slate-100 text-slate-500 px-2.5 py-0.5 rounded-full">${Object.keys(sectionItems).length} elements</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 accordion-icon"></i>
                                </div>
                            </button>
                            <div id="${sectionTargetId}" class="accordion-content">
                                <div class="divide-y divide-slate-100">
                                    ${rowsHtml}
                                </div>
                            </div>
                        `;
                        sectionsWrapper.appendChild(sectionBlock);

                        // Setup Section level toggle
                        const secBtn = sectionBlock.querySelector('.section-toggle');
                        secBtn.addEventListener('click', function () {
                            const content = document.getElementById(sectionTargetId);
                            const icon = this.querySelector('.accordion-icon');
                            content.classList.toggle('open');
                            icon.classList.toggle('open');
                        });
                    });
                });

                loading.classList.add('hidden');
                container.classList.remove('hidden');
                lucide.createIcons(); // refresh icons after injecting HTML
            }

            saveBtn.addEventListener('click', () => {
                const textareas = document.querySelectorAll('textarea[data-id]');
                const updateData = {};

                // Show loading state on button
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline shadow-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Syncing...';
                saveBtn.disabled = true;

                textareas.forEach(ta => {
                    const val = ta.value.trim();
                    if (val) {
                        updateData[ta.getAttribute('data-id')] = val;
                    }
                });

                // Update Firebase
                sitemapRef.set(updateData)
                    .then(() => {
                        // Reset button
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;

                        // Show toast
                        toast.classList.add('show');
                        setTimeout(() => toast.classList.remove('show'), 3000);

                        // Slightly optimize: we might want to refresh icons if we re-render entirely.
                    })
                    .catch((error) => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                        alert('Sync failed: ' + error.message);
                    });
            });

            function escapeHTML(str) {
                return str.replace(/[&<>'"]/g,
                    tag => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        "'": '&#39;',
                        '"': '&quot;'
                    }[tag])
                );
            }
        });
    </script>
</body>

</html>