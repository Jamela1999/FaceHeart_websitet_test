<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexsas Sitemap Content Manager</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="assets/firebase-config.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .accordion-content {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .accordion-content.open {
            max-height: 9000px;
            opacity: 1;
            overflow: visible;
        }

        .accordion-icon {
            transition: transform 0.2s;
        }

        .accordion-icon.open {
            transform: rotate(180deg);
        }

        .editor-row {
            transition: all 0.2s;
            border-bottom: 1px solid #f1f5f9;
        }

        .editor-row:last-child {
            border-bottom: none;
        }

        .editor-row:hover {
            background-color: #f8fafc;
        }

        .success-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 50;
        }

        .success-toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Hidden iframe container used to fetch original styles */
        #style-fetcher-container {
            position: absolute;
            width: 0;
            height: 0;
            overflow: hidden;
            visibility: hidden;
            pointer-events: none;
            opacity: 0;
        }
    </style>
</head>

<body class="text-slate-800 antialiased min-h-screen">

    <div class="max-w-6xl mx-auto px-4 py-12">
        <div
            class="flex items-center justify-between mb-8 pb-4 border-b border-slate-200 sticky top-0 bg-[#f8fafc] z-40 py-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Sitemap Content Manager</h1>
                <p class="text-slate-500 mt-1">Manage text content, font sizes, and colors directly.</p>
            </div>
            <div class="flex gap-4">
                <a href="index.html" target="_blank"
                    class="px-5 py-2.5 bg-white border border-slate-300 text-slate-700 font-medium rounded-lg hover:bg-slate-50 transition-colors shadow-sm text-sm flex items-center gap-2">
                    <i data-lucide="external-link" class="w-4 h-4"></i> Preview Home
                </a>
                <button id="save-btn"
                    class="px-5 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm text-sm flex items-center gap-2">
                    <i data-lucide="cloud-upload" class="w-4 h-4"></i> Sync All Changes
                </button>
            </div>
        </div>

        <div id="loading" class="text-center py-20 text-slate-500">
            <svg class="animate-spin h-8 w-8 mx-auto mb-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            Loading categorized content maps...
        </div>

        <div id="content-container" class="hidden space-y-4">
            <!-- Accordions injected here -->
        </div>
    </div>

    <div id="toast" class="success-toast flex items-center gap-2">
        <i data-lucide="check-circle" class="w-5 h-5"></i>
        Changes synchronized to Firebase successfully!
    </div>

    <div id="style-fetcher-container"></div>

    <script>
        // Initialize lucide icons
        lucide.createIcons();

        document.addEventListener("DOMContentLoaded", async () => {
            const container = document.getElementById('content-container');
            const saveBtn = document.getElementById('save-btn');
            const loading = document.getElementById('loading');
            const toast = document.getElementById('toast');
            const styleContainer = document.getElementById('style-fetcher-container');

            let structuredContent = {};
            let firebaseData = {};
            const loadedPages = new Set(); // Keep track of iframes we've already loaded to grab styles

            if (typeof database === 'undefined') {
                container.innerHTML = `<div class="p-8 bg-white rounded-xl text-center text-red-500 font-medium shadow-sm border border-red-200">Error: Firebase is not configured in assets/firebase-config.js.</div>`;
                loading.classList.add('hidden');
                container.classList.remove('hidden');
                return;
            }

            const sitemapRef = database.ref('sitemap/content');

            try {
                // Append timestamp to prevent browser caching of the JSON mapping
                const response = await fetch('content.json?v=' + new Date().getTime());
                structuredContent = await response.json();

                sitemapRef.once('value', (snapshot) => {
                    firebaseData = snapshot.val() || {};
                    renderAccordions();
                });

            } catch (err) {
                console.error("Failed to load content:", err);
                loading.innerHTML = `<div class="text-red-500">Failed to load content.json. Did you run the Python extraction script?</div>`;
            }

            // Function to fetch and populate original styles from the actual page
            function loadOriginalStylesForPage(fileName, pageIndex) {
                if (loadedPages.has(fileName)) return; // Already loaded
                loadedPages.add(fileName);

                // Show tiny loader indicating styles are fetching
                document.querySelectorAll(`.style-loader-${pageIndex}`).forEach(el => el.classList.remove('hidden'));

                const iframe = document.createElement('iframe');
                iframe.src = fileName;
                // Once loaded, read the DOM
                iframe.onload = () => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        document.querySelectorAll(`.row-page-${pageIndex}`).forEach(row => {
                            const cid = row.getAttribute('data-id');
                            const target = iframeDoc.querySelector(`[data-content-id="${cid}"]`);
                            if (target) {
                                const styles = iframe.contentWindow.getComputedStyle(target);
                                const origSizeElem = row.querySelector('.orig-size');
                                const origColorElem = row.querySelector('.orig-color');
                                const origColorBox = row.querySelector('.orig-color-box');

                                if (origSizeElem) origSizeElem.innerText = styles.fontSize;
                                if (origColorElem) origColorElem.innerText = styles.color;
                                if (origColorBox) origColorBox.style.backgroundColor = styles.color;
                            }
                        });

                        // Hide loaders
                        document.querySelectorAll(`.style-loader-${pageIndex}`).forEach(el => el.classList.add('hidden'));
                    } catch (e) {
                        console.error("Cannot read iframe styles. Make sure you are running a local server.", e);
                        document.querySelectorAll(`.style-loader-${pageIndex}`).forEach(el => {
                            el.innerText = 'Error loading styles';
                            el.classList.add('text-red-500');
                        });
                    }
                };
                styleContainer.appendChild(iframe);
            }

            function renderAccordions() {
                container.innerHTML = '';

                Object.keys(structuredContent).sort().forEach((pageName, pIndex) => {
                    const pageSections = structuredContent[pageName];
                    const pageBlock = document.createElement('div');
                    pageBlock.className = 'bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden';

                    let pageTotalItems = 0;
                    let targetFileName = '';
                    Object.values(pageSections).forEach(sec => {
                        Object.keys(sec).forEach(id => {
                            pageTotalItems++;
                            if (!targetFileName) targetFileName = sec[id].file;
                        });
                    });

                    const pageHeaderId = `page-header-${pIndex}`;
                    const targetPageId = `page-content-${pIndex}`;

                    pageBlock.innerHTML = `
                        <button id="${pageHeaderId}" class="w-full flex items-center justify-between p-5 bg-white hover:bg-slate-50 transition-colors text-left focus:outline-none focus:bg-slate-50">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
                                    <i data-lucide="file-text" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h2 class="text-lg font-bold text-slate-800">${pageName}</h2>
                                    <p class="text-xs text-slate-500">${Object.keys(pageSections).length} sections, ${pageTotalItems} text elements</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-slate-400 font-mono">${targetFileName}</span>
                                <i data-lucide="chevron-down" class="w-5 h-5 text-slate-400 accordion-icon"></i>
                            </div>
                        </button>
                        <div id="${targetPageId}" class="accordion-content bg-slate-50 border-t border-slate-100">
                            <div class="p-4 space-y-4" id="sections-${pIndex}"></div>
                        </div>
                    `;
                    container.appendChild(pageBlock);

                    // Setup Page level toggle
                    document.getElementById(pageHeaderId).addEventListener('click', function () {
                        const content = document.getElementById(targetPageId);
                        const icon = this.querySelector('.accordion-icon');
                        content.classList.toggle('open');
                        icon.classList.toggle('open');

                        // Load iframe in background to extract styles if not already done
                        if (content.classList.contains('open') && targetFileName) {
                            loadOriginalStylesForPage(targetFileName, pIndex);
                        }
                    });

                    // Render Sections inside Page
                    const sectionsWrapper = document.getElementById(`sections-${pIndex}`);
                    Object.keys(pageSections).sort().forEach((sectionName, sIndex) => {
                        const sectionItems = pageSections[sectionName];
                        const sectionBlock = document.createElement('div');
                        sectionBlock.className = 'bg-white rounded-lg shadow-sm border border-slate-200 overflow-visible';

                        const sectionTargetId = `section-${pIndex}-${sIndex}`;

                        let rowsHtml = '';
                        Object.keys(sectionItems).forEach(id => {
                            const item = sectionItems[id];

                            // Support old string format or new object format
                            let fbVal = firebaseData[id] || {};
                            if (typeof fbVal === 'string') fbVal = { text: fbVal };

                            const currentText = fbVal.text || '';
                            const currentColor = fbVal.color || '';
                            const currentSize = fbVal.fontSize || '';

                            const hasOverride = currentText.trim() !== '' || currentColor.trim() !== '' || currentSize.trim() !== '';

                            rowsHtml += `
                                <div class="grid grid-cols-12 gap-6 p-5 editor-row items-start row-page-${pIndex} ${hasOverride ? 'bg-blue-50/30' : ''}" data-id="${id}">
                                    <div class="col-span-3 pt-1 space-y-2">
                                        <div class="flex items-center gap-2">
                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-slate-100 text-slate-600 uppercase tracking-wider">
                                                &lt;${item.tag}&gt;
                                            </span>
                                            <div class="text-[11px] text-slate-400 font-mono bg-slate-100/50 px-2 py-1 rounded inline-block border border-slate-100">${id}</div>
                                        </div>
                                        <div class="mt-2 text-xs text-slate-500 bg-slate-50 p-2 rounded border border-slate-100 relative">
                                            <div class="flex items-center justify-center absolute inset-0 bg-slate-50/80 hidden style-loader-${pIndex}">
                                                <i data-lucide="loader" class="w-3 h-3 animate-spin text-slate-400"></i>
                                            </div>
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="font-medium">Original Size:</span>
                                                <span class="font-mono orig-size text-[10px]">-</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium">Original Color:</span>
                                                <div class="flex items-center gap-1.5">
                                                    <span class="orig-color-box w-2 h-2 rounded-full border border-slate-200 shadow-sm" style="background-color: transparent"></span>
                                                    <span class="font-mono orig-color text-[10px]">-</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <a href="${item.file}?preview=${id}" target="_blank" class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 hover:text-indigo-700 rounded-md text-[11px] font-semibold transition-colors">
                                                <i data-lucide="eye" class="w-3.5 h-3.5"></i> Preview Location
                                            </a>
                                        </div>
                                    </div>
                                    <div class="col-span-4 pt-1 pr-4 text-[13px] text-slate-600 border-r border-slate-100 leading-relaxed font-medium">
                                        ${escapeHTML(item.text)}
                                    </div>
                                    <div class="col-span-5 relative space-y-3">
                                        ${hasOverride ? `<span class="absolute top-1 right-1 flex h-2 w-2 rounded-full bg-blue-500"></span>` : ''}
                                        <div>
                                            <label class="block text-xs font-semibold text-slate-500 mb-1">Text Override</label>
                                            <textarea 
                                                class="w-full text-sm border border-slate-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 p-2 min-h-[60px] resize-y bg-white input-text" 
                                                data-id="${id}"
                                            >${escapeHTML(currentText)}</textarea>
                                        </div>
                                        <div class="flex gap-3">
                                            <div class="flex-1">
                                                <label class="block text-xs font-semibold text-slate-500 mb-1">Font Size</label>
                                                <input type="text" placeholder="e.g. 24px" value="${escapeHTML(currentSize)}" class="input-size w-full text-[13px] border border-slate-300 rounded shadow-sm py-1.5 px-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" data-id="${id}">
                                            </div>
                                            <div class="flex-1">
                                                <label class="block text-xs font-semibold text-slate-500 mb-1">Color (RGB/Hex)</label>
                                                <input type="text" placeholder="e.g. #ff0000 or red" value="${escapeHTML(currentColor)}" class="input-color w-full text-[13px] border border-slate-300 rounded shadow-sm py-1.5 px-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" data-id="${id}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                        sectionBlock.innerHTML = `
                            <button class="section-toggle w-full flex items-center justify-between p-4 bg-white hover:bg-slate-50 transition-colors border-b border-slate-100 text-left focus:outline-none">
                                <h3 class="font-semibold text-slate-700 flex items-center gap-2 text-sm">
                                    <i data-lucide="layout" class="w-4 h-4 text-slate-400"></i>
                                    ${sectionName}
                                </h3>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs font-medium bg-slate-100 text-slate-500 px-2.5 py-0.5 rounded-full">${Object.keys(sectionItems).length} items</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 accordion-icon"></i>
                                </div>
                            </button>
                            <div id="${sectionTargetId}" class="accordion-content">
                                <div class="divide-y divide-slate-100">
                                    ${rowsHtml}
                                </div>
                            </div>
                        `;
                        sectionsWrapper.appendChild(sectionBlock);

                        // Setup Section level toggle
                        const secBtn = sectionBlock.querySelector('.section-toggle');
                        secBtn.addEventListener('click', function () {
                            const content = document.getElementById(sectionTargetId);
                            const icon = this.querySelector('.accordion-icon');
                            content.classList.toggle('open');
                            icon.classList.toggle('open');
                        });
                    });
                });

                loading.classList.add('hidden');
                container.classList.remove('hidden');
                lucide.createIcons(); // refresh icons after injecting HTML
            }

            saveBtn.addEventListener('click', () => {
                const rows = document.querySelectorAll('.editor-row');
                const updateData = {};

                // Show loading state on button
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline shadow-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Syncing...';
                saveBtn.disabled = true;

                rows.forEach(row => {
                    const id = row.getAttribute('data-id');
                    const textVal = row.querySelector('.input-text').value.trim();
                    const sizeVal = row.querySelector('.input-size').value.trim();
                    const colorVal = row.querySelector('.input-color').value.trim();

                    if (textVal || sizeVal || colorVal) {
                        updateData[id] = {};
                        if (textVal) updateData[id].text = textVal;
                        if (sizeVal) updateData[id].fontSize = sizeVal;
                        if (colorVal) updateData[id].color = colorVal;
                    }
                });

                // Update Firebase
                sitemapRef.set(updateData)
                    .then(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;

                        toast.classList.add('show');
                        setTimeout(() => toast.classList.remove('show'), 3000);
                    })
                    .catch((error) => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                        alert('Sync failed: ' + error.message);
                    });
            });

            function escapeHTML(str) {
                return str.replace(/[&<>'"]/g,
                    tag => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        "'": '&#39;',
                        '"': '&quot;'
                    }[tag])
                );
            }
        });
    </script>
</body>

</html>