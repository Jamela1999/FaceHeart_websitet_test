<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexsas Sitemap Content Manager</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="assets/firebase-config.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .editor-row {
            transition: all 0.2s;
        }

        .editor-row:hover {
            background-color: #f1f5f9;
        }

        .success-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }

        .success-toast.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>

<body class="text-slate-800 antialiased min-h-screen">

    <div class="max-w-5xl mx-auto px-4 py-12">
        <div class="flex items-center justify-between mb-8 pb-4 border-b border-slate-200">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Sitemap Content Manager</h1>
                <p class="text-slate-500 mt-2">Manage text content for your website seamlessly.</p>
            </div>
            <div class="flex gap-4">
                <a href="index.html" target="_blank"
                    class="px-5 py-2.5 bg-white border border-slate-300 text-slate-700 font-medium rounded-lg hover:bg-slate-50 transition-colors shadow-sm text-sm">Preview
                    Site</a>
                <button id="save-btn"
                    class="px-5 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4">
                        </path>
                    </svg>
                    Save Changes Sync
                </button>
            </div>
        </div>

        <div id="loading" class="text-center py-20 text-slate-500">
            <svg class="animate-spin h-8 w-8 mx-auto mb-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            Loading content...
        </div>

        <div id="content-container"
            class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hidden">
            <div
                class="grid grid-cols-12 gap-4 p-4 bg-slate-50 border-b border-slate-200 text-sm font-semibold text-slate-600">
                <div class="col-span-2">Element Type</div>
                <div class="col-span-5">Original Text</div>
                <div class="col-span-5">New Text Override</div>
            </div>
            <div id="forms-wrapper" class="divide-y divide-slate-100">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <div id="toast" class="success-toast">
        Changes synchronized to Firebase successfully!
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const container = document.getElementById('forms-wrapper');
            const saveBtn = document.getElementById('save-btn');
            const loading = document.getElementById('loading');
            const mainContainer = document.getElementById('content-container');
            const toast = document.getElementById('toast');

            let originalContent = {};
            let firebaseData = {};

            if (typeof database === 'undefined') {
                container.innerHTML = `<div class="p-8 text-center text-red-500 font-medium">Error: Firebase is not configured in assets/firebase-config.js.</div>`;
                loading.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                return;
            }

            const sitemapRef = database.ref('sitemap/content');

            try {
                // Fetch the JSON generated by Python script
                const response = await fetch('content.json');
                originalContent = await response.json();

                // Fetch existing overrides from Firebase
                sitemapRef.once('value', (snapshot) => {
                    firebaseData = snapshot.val() || {};
                    renderForms();
                });

            } catch (err) {
                console.error("Failed to load content:", err);
                loading.innerHTML = `<div class="text-red-500">Failed to load content.json. Did you run the Python extraction script?</div>`;
            }

            function renderForms() {
                container.innerHTML = '';
                Object.keys(originalContent).forEach(id => {
                    const item = originalContent[id];
                    const currentValue = firebaseData[id] || '';

                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-12 gap-4 p-4 editor-row items-start';
                    row.innerHTML = `
                        <div class="col-span-2 pt-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-100 text-blue-800 uppercase tracking-wide">
                                ${item.tag}
                            </span>
                            <div class="text-xs text-slate-400 mt-2 font-mono">${id}</div>
                        </div>
                        <div class="col-span-5 pt-2 pr-4 text-sm text-slate-600 border-r border-slate-100">
                            ${escapeHTML(item.text)}
                        </div>
                        <div class="col-span-5">
                            <textarea 
                                class="w-full text-sm border-slate-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 min-h-[60px] resize-y" 
                                placeholder="Enter custom text..." 
                                data-id="${id}"
                            >${escapeHTML(currentValue)}</textarea>
                            <div class="text-xs text-slate-400 mt-1">Leave empty to use original text.</div>
                        </div>
                    `;
                    container.appendChild(row);
                });

                loading.classList.add('hidden');
                mainContainer.classList.remove('hidden');
            }

            saveBtn.addEventListener('click', () => {
                const textareas = document.querySelectorAll('textarea[data-id]');
                const updateData = {};

                // Show loading state on button
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = 'Syncing...';
                saveBtn.disabled = true;

                textareas.forEach(ta => {
                    const val = ta.value.trim();
                    if (val) {
                        updateData[ta.getAttribute('data-id')] = val;
                    }
                });

                // Update Firebase
                sitemapRef.set(updateData)
                    .then(() => {
                        // Reset button
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;

                        // Show toast
                        toast.classList.add('show');
                        setTimeout(() => toast.classList.remove('show'), 3000);
                    })
                    .catch((error) => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                        alert('Sync failed: ' + error.message);
                    });
            });

            function escapeHTML(str) {
                return str.replace(/[&<>'"]/g,
                    tag => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        "'": '&#39;',
                        '"': '&quot;'
                    }[tag])
                );
            }
        });
    </script>
</body>

</html>